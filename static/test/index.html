<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Report</title><link rel="stylesheet" href="assets\app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:27,&quot;tests&quot;:87,&quot;passes&quot;:87,&quot;pending&quot;:0,&quot;failures&quot;:0,&quot;start&quot;:&quot;2020-04-22T21:53:27.791Z&quot;,&quot;end&quot;:&quot;2020-04-22T21:53:28.645Z&quot;,&quot;duration&quot;:854,&quot;testsRegistered&quot;:87,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;068c1243-3cae-45d0-a113-d9ef94060232&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;00c3c4ce-9abc-46b4-be9d-36db36356aee&quot;,&quot;title&quot;:&quot;LoginController&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-controller.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-controller.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;LoginController \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_h1ok71qyf().f[2]++;cov_h1ok71qyf().s[12]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;57fdb98b-fdcd-425b-983d-b6f0763a3c2e&quot;,&quot;parentUUID&quot;:&quot;00c3c4ce-9abc-46b4-be9d-36db36356aee&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;logs in, if credentials correct&quot;,&quot;fullTitle&quot;:&quot;LoginController logs in, if credentials correct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_h1ok71qyf().f[3]++;const requestBody=(cov_h1ok71qyf().s[14]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;123456&#x27;});const dbUser=(cov_h1ok71qyf().s[15]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;hashed&#x27;,isBetaUser:false,get(){cov_h1ok71qyf().f[4]++;cov_h1ok71qyf().s[16]++;return this;}});const expectedJwt=(cov_h1ok71qyf().s[17]++,{username:&#x27;demo&#x27;,isBetaUser:false});// Stub bcrypt comparing\nconst compareStub=(cov_h1ok71qyf().s[18]++,sandbox.stub(bcrypt_1.default,&#x27;compare&#x27;));cov_h1ok71qyf().s[19]++;compareStub.resolves(true);// Stub database\nconst findByUsernameStub=(cov_h1ok71qyf().s[20]++,sandbox.stub(user_1.default,&#x27;findByUsername&#x27;));cov_h1ok71qyf().s[21]++;findByUsernameStub.usingPromise(bluebird_1.default).resolves(dbUser);// Stub express\nconst requestStub=(cov_h1ok71qyf().s[22]++,sandbox.stub());cov_h1ok71qyf().s[23]++;requestStub.body=requestBody;const responseStub=(cov_h1ok71qyf().s[24]++,sandbox.stub());cov_h1ok71qyf().s[25]++;responseStub.setJwtToken=sinon_1.fake();const next=(cov_h1ok71qyf().s[26]++,sinon_1.fake());cov_h1ok71qyf().s[27]++;responseStub.send=sinon_1.fake(()=&gt;{cov_h1ok71qyf().f[5]++;cov_h1ok71qyf().s[28]++;sandbox.assert.calledWith(compareStub,requestBody.password,dbUser.password);cov_h1ok71qyf().s[29]++;sinon_1.assert.notCalled(next);cov_h1ok71qyf().s[30]++;sandbox.assert.calledOnce(responseStub.send);cov_h1ok71qyf().s[31]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.instanceOf(user_dto_1.default));cov_h1ok71qyf().s[32]++;sandbox.assert.calledWith(findByUsernameStub,requestBody.username);cov_h1ok71qyf().s[33]++;sandbox.assert.calledOnce(responseStub.setJwtToken);cov_h1ok71qyf().s[34]++;sandbox.assert.calledWith(responseStub.setJwtToken,sinon_1.match(expectedJwt));cov_h1ok71qyf().s[35]++;done();});cov_h1ok71qyf().s[36]++;login_controller_1.default(requestStub,responseStub,next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c26e9dfc-474d-4d04-9541-762bef9df58b&quot;,&quot;parentUUID&quot;:&quot;00c3c4ce-9abc-46b4-be9d-36db36356aee&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;62025f11-4c2a-4b02-ae16-0976f68f72e4&quot;,&quot;title&quot;:&quot;throws error&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-controller.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-controller.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;if database throws error while finding user&quot;,&quot;fullTitle&quot;:&quot;LoginController throws error if database throws error while finding user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_h1ok71qyf().f[7]++;const requestBody=(cov_h1ok71qyf().s[39]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;123456&#x27;});const dbError=(cov_h1ok71qyf().s[40]++,new Error(&#x27;SOME MESSAGE&#x27;));// Stub database\nconst findOneStub=(cov_h1ok71qyf().s[41]++,sandbox.stub(user_1.default,&#x27;findOne&#x27;));cov_h1ok71qyf().s[42]++;findOneStub.usingPromise(bluebird_1.default).rejects(dbError);// Stub express\nconst requestStub=(cov_h1ok71qyf().s[43]++,sandbox.stub());cov_h1ok71qyf().s[44]++;requestStub.body=requestBody;const responseStub=(cov_h1ok71qyf().s[45]++,sandbox.stub());cov_h1ok71qyf().s[46]++;responseStub.send=sandbox.stub();const next=(cov_h1ok71qyf().s[47]++,sinon_1.fake(err=&gt;{cov_h1ok71qyf().f[8]++;cov_h1ok71qyf().s[48]++;sandbox.assert.notCalled(responseStub.send);cov_h1ok71qyf().s[49]++;sinon_1.assert.calledWith(next,sinon_1.match(dbError));cov_h1ok71qyf().s[50]++;done();}));cov_h1ok71qyf().s[51]++;login_controller_1.default(requestStub,responseStub,next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;42cfdbfb-1093-4825-a60c-5d6bf3534706&quot;,&quot;parentUUID&quot;:&quot;62025f11-4c2a-4b02-ae16-0976f68f72e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if given password doesn&#x27;t match stored hash&quot;,&quot;fullTitle&quot;:&quot;LoginController throws error if given password doesn&#x27;t match stored hash&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_h1ok71qyf().f[9]++;const requestBody=(cov_h1ok71qyf().s[53]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;123456&#x27;});const dbUser=(cov_h1ok71qyf().s[54]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;hashed&#x27;});// Stub bcrypt comparing\nconst compareStub=(cov_h1ok71qyf().s[55]++,sandbox.stub(bcrypt_1.default,&#x27;compare&#x27;));cov_h1ok71qyf().s[56]++;compareStub.resolves(false);// Stub database\nconst findOneStub=(cov_h1ok71qyf().s[57]++,sandbox.stub(user_1.default,&#x27;findOne&#x27;));cov_h1ok71qyf().s[58]++;findOneStub.usingPromise(bluebird_1.default).resolves(dbUser);// Stub express\nconst requestStub=(cov_h1ok71qyf().s[59]++,sandbox.stub());cov_h1ok71qyf().s[60]++;requestStub.body=requestBody;const responseStub=(cov_h1ok71qyf().s[61]++,sandbox.stub());cov_h1ok71qyf().s[62]++;responseStub.send=sandbox.stub();const next=(cov_h1ok71qyf().s[63]++,sinon_1.fake(()=&gt;{cov_h1ok71qyf().f[10]++;cov_h1ok71qyf().s[64]++;sinon_1.assert.notCalled(responseStub.send);cov_h1ok71qyf().s[65]++;sinon_1.assert.calledWith(compareStub,requestBody.password,dbUser.password);cov_h1ok71qyf().s[66]++;sinon_1.assert.calledWith(findOneStub,sinon_1.match({where:{username:requestBody.username}}));cov_h1ok71qyf().s[67]++;sinon_1.assert.calledWith(next,sinon_1.match.hasNested(&#x27;constructor.name&#x27;,&#x27;InvalidLoginError&#x27;));cov_h1ok71qyf().s[68]++;sinon_1.assert.calledWith(next,sinon_1.match.has(&#x27;message&#x27;,&#x27;Username or email is invalid&#x27;));cov_h1ok71qyf().s[69]++;sinon_1.assert.calledWith(next,sinon_1.match.has(&#x27;statusCode&#x27;,400));cov_h1ok71qyf().s[70]++;done();}));cov_h1ok71qyf().s[71]++;login_controller_1.default(requestStub,responseStub,next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f1170b49-771b-4ff6-8456-6bc0d9c29162&quot;,&quot;parentUUID&quot;:&quot;62025f11-4c2a-4b02-ae16-0976f68f72e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if database can&#x27;t find user&quot;,&quot;fullTitle&quot;:&quot;LoginController throws error if database can&#x27;t find user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_h1ok71qyf().f[11]++;const requestBody=(cov_h1ok71qyf().s[73]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;123456&#x27;});// Stub bcrypt comparing\nconst compareStub=(cov_h1ok71qyf().s[74]++,sandbox.stub(bcrypt_1.default,&#x27;compare&#x27;));// Stub database\nconst findOneStub=(cov_h1ok71qyf().s[75]++,sandbox.stub(user_1.default,&#x27;findOne&#x27;));cov_h1ok71qyf().s[76]++;findOneStub.usingPromise(bluebird_1.default).resolves(null);// Stub express\nconst requestStub=(cov_h1ok71qyf().s[77]++,sandbox.stub());cov_h1ok71qyf().s[78]++;requestStub.body=requestBody;const responseStub=(cov_h1ok71qyf().s[79]++,sandbox.stub());cov_h1ok71qyf().s[80]++;responseStub.send=sinon_1.stub();const next=(cov_h1ok71qyf().s[81]++,sinon_1.fake(()=&gt;{cov_h1ok71qyf().f[12]++;cov_h1ok71qyf().s[82]++;sinon_1.assert.notCalled(responseStub.send);cov_h1ok71qyf().s[83]++;sinon_1.assert.notCalled(compareStub);cov_h1ok71qyf().s[84]++;sinon_1.assert.calledWith(findOneStub,sinon_1.match({where:{username:requestBody.username}}));cov_h1ok71qyf().s[85]++;sinon_1.assert.calledWith(next,sinon_1.match.hasNested(&#x27;constructor.name&#x27;,&#x27;InvalidLoginError&#x27;));cov_h1ok71qyf().s[86]++;sinon_1.assert.calledWith(next,sinon_1.match.has(&#x27;message&#x27;,&#x27;Username or email is invalid&#x27;));cov_h1ok71qyf().s[87]++;sinon_1.assert.calledWith(next,sinon_1.match.has(&#x27;statusCode&#x27;,400));cov_h1ok71qyf().s[88]++;done();}));cov_h1ok71qyf().s[89]++;login_controller_1.default(requestStub,responseStub,next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a4a7f0ed-9a4d-409c-bc2e-4fa4f829db47&quot;,&quot;parentUUID&quot;:&quot;62025f11-4c2a-4b02-ae16-0976f68f72e4&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;42cfdbfb-1093-4825-a60c-5d6bf3534706&quot;,&quot;f1170b49-771b-4ff6-8456-6bc0d9c29162&quot;,&quot;a4a7f0ed-9a4d-409c-bc2e-4fa4f829db47&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:16,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[&quot;c26e9dfc-474d-4d04-9541-762bef9df58b&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;ab3ca40c-06be-4062-95f9-0742c1d3a27f&quot;,&quot;title&quot;:&quot;LoginRouter&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;LoginRouter \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:25,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[3]++;const csrfHeaderName=(cov_82vozmil3().s[23]++,config_1.default.jwt.securityOptions.tokenName.toLowerCase());cov_82vozmil3().s[24]++;jwt=&#x27;FAIL&#x27;;// Get csrf token\ncov_82vozmil3().s[25]++;csrf=await supertest_1.default(app_1.default).head(&#x27;/auth&#x27;).then(response=&gt;{cov_82vozmil3().f[4]++;cov_82vozmil3().s[26]++;// Save jwt cookie\njwt=response.header[&#x27;set-cookie&#x27;].pop().split(&#x27;;&#x27;)[0];cov_82vozmil3().s[27]++;return response.header[csrfHeaderName];});cov_82vozmil3().s[28]++;await db_1.syncPromise;cov_82vozmil3().s[29]++;return db_1.default.sync({force:true});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;26814e80-1988-4f87-ad9b-f978d9b94200&quot;,&quot;parentUUID&quot;:&quot;ab3ca40c-06be-4062-95f9-0742c1d3a27f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;logs in, if user exists and password is correct&quot;,&quot;fullTitle&quot;:&quot;LoginRouter logs in, if user exists and password is correct&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:51,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[11]++;const userData=(cov_82vozmil3().s[46]++,{username:&#x27;test&#x27;,email:&#x27;test@mail.com&#x27;,password:&#x27;testPassword&#x27;});const loginBody=(cov_82vozmil3().s[47]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});// Create user in database\ncov_82vozmil3().s[48]++;await user_1.default.create(userData);cov_82vozmil3().s[49]++;await supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).send(loginBody).expect(200).then(response=&gt;{cov_82vozmil3().f[12]++;cov_82vozmil3().s[50]++;chai_1.expect(response.body).to.have.property(&#x27;username&#x27;,userData.username);cov_82vozmil3().s[51]++;chai_1.expect(response.body).to.have.property(&#x27;email&#x27;,userData.email);cov_82vozmil3().s[52]++;chai_1.expect(response.body).to.have.property(&#x27;createdAt&#x27;);cov_82vozmil3().s[53]++;chai_1.expect(response.body).to.have.property(&#x27;updatedAt&#x27;);cov_82vozmil3().s[54]++;chai_1.expect(response.body).to.not.have.property(&#x27;password&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4c2d8e17-7c8f-4d99-8d5c-2d99900f84bb&quot;,&quot;parentUUID&quot;:&quot;ab3ca40c-06be-4062-95f9-0742c1d3a27f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;d4cd80ad-d984-4b9e-a6eb-be581ef76240&quot;,&quot;title&quot;:&quot;responses with 400&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;if no username and password given&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 400 if no username and password given&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:5,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[6]++;cov_82vozmil3().s[32]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).expect(400);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53b66848-5882-4f8b-80a9-47c829ffddd8&quot;,&quot;parentUUID&quot;:&quot;d4cd80ad-d984-4b9e-a6eb-be581ef76240&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if user doesn&#x27;t exist&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 400 if user doesn&#x27;t exist&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:6,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[7]++;const body=(cov_82vozmil3().s[34]++,{username:&#x27;demo&#x27;,password:&#x27;password&#x27;});cov_82vozmil3().s[35]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).send(body).expect(400).then(response=&gt;{cov_82vozmil3().f[8]++;cov_82vozmil3().s[36]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;,&#x27;Username or email is invalid&#x27;);cov_82vozmil3().s[37]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;fc78eab9-905d-4651-8f2a-475ebc8d4e32&quot;,&quot;parentUUID&quot;:&quot;d4cd80ad-d984-4b9e-a6eb-be581ef76240&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if password is wrong&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 400 if password is wrong&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[9]++;const userData=(cov_82vozmil3().s[39]++,{username:&#x27;test&#x27;,email:&#x27;test@mail.com&#x27;,password:&#x27;testPassword&#x27;});const loginBody=(cov_82vozmil3().s[40]++,{username:&#x27;test&#x27;,password:&#x27;wrong password&#x27;});// Create user in database\ncov_82vozmil3().s[41]++;await user_1.default.create(userData);cov_82vozmil3().s[42]++;await supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(loginBody).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).expect(400).then(response=&gt;{cov_82vozmil3().f[10]++;cov_82vozmil3().s[43]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;,&#x27;Username or email is invalid&#x27;);cov_82vozmil3().s[44]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;97c2d9c0-84de-4bcb-9fde-269df7c52b61&quot;,&quot;parentUUID&quot;:&quot;d4cd80ad-d984-4b9e-a6eb-be581ef76240&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;53b66848-5882-4f8b-80a9-47c829ffddd8&quot;,&quot;fc78eab9-905d-4651-8f2a-475ebc8d4e32&quot;,&quot;97c2d9c0-84de-4bcb-9fde-269df7c52b61&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:21,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;title&quot;:&quot;responses with 401&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-router.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;if request is missing a jwt token&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if request is missing a jwt token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[14]++;const loginBody=(cov_82vozmil3().s[57]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[58]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(loginBody).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b9f176a-6736-4719-ab60-df9b27f8455a&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token exists but without secret&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if jwt token exists but without secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[15]++;const loginBody=(cov_82vozmil3().s[60]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[61]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(loginBody).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;64b634ae-0bec-41d8-a401-fe86fddba7f9&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if csrf header exist but no jwt&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if csrf header exist but no jwt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[16]++;const loginBody=(cov_82vozmil3().s[63]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[64]++;jwt=jsonwebtoken_1.default.sign({username:&#x27;username&#x27;},config_1.default.jwt.secret,config_1.default.jwt.getOptions());cov_82vozmil3().s[65]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(loginBody).set(&#x27;Cookie&#x27;,[jwt]).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7754dcdb-d36c-4455-9a6d-f0d44ff4b092&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token with secret exists but no header for the csrf token&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if jwt token with secret exists but no header for the csrf token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[17]++;const loginBody=(cov_82vozmil3().s[67]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[68]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(&#x27;Cookie&#x27;,[jwt]).send(loginBody).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;37d18e5d-9b92-4ada-8233-b707104f88d8&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token and csrf header exist, but jwt token has no secret&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if jwt token and csrf header exist, but jwt token has no secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[18]++;const loginBody=(cov_82vozmil3().s[70]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[71]++;jwt=jsonwebtoken_1.default.sign({username:&#x27;username&#x27;},config_1.default.jwt.secret,config_1.default.jwt.getOptions());cov_82vozmil3().s[72]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).send(loginBody).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f35e2602-bb20-41a4-8df5-b930e79180f0&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token with secret and csrf header exist, but they don&#x27;t belong together&quot;,&quot;fullTitle&quot;:&quot;LoginRouter responses with 401 if jwt token with secret and csrf header exist, but they don&#x27;t belong together&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_82vozmil3().f[19]++;const loginBody=(cov_82vozmil3().s[74]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_82vozmil3().s[75]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,&#x27;FAIL&#x27;).set(&#x27;Cookie&#x27;,[jwt]).send(loginBody).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;71a9efc4-3b57-4358-a567-37c60d6e02af&quot;,&quot;parentUUID&quot;:&quot;a0826892-7fcd-4336-8564-ad73c7451c5b&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8b9f176a-6736-4719-ab60-df9b27f8455a&quot;,&quot;64b634ae-0bec-41d8-a401-fe86fddba7f9&quot;,&quot;7754dcdb-d36c-4455-9a6d-f0d44ff4b092&quot;,&quot;37d18e5d-9b92-4ada-8233-b707104f88d8&quot;,&quot;f35e2602-bb20-41a4-8df5-b930e79180f0&quot;,&quot;71a9efc4-3b57-4358-a567-37c60d6e02af&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:17,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[&quot;4c2d8e17-7c8f-4d99-8d5c-2d99900f84bb&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:51,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;fff4626b-ea0f-4840-9183-342288fcd41e&quot;,&quot;title&quot;:&quot;LoginRouter&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\login\\login-router.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\login\\login-router.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;LoginRouter \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ln8b5ime6().f[3]++;cov_1ln8b5ime6().s[23]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0c672b0a-d304-4d68-bb38-09e97e382c3e&quot;,&quot;parentUUID&quot;:&quot;fff4626b-ea0f-4840-9183-342288fcd41e&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;calls next if no validation errors occurred&quot;,&quot;fullTitle&quot;:&quot;LoginRouter calls next if no validation errors occurred&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ln8b5ime6().f[4]++;const requestStub=(cov_1ln8b5ime6().s[25]++,sandbox.stub());cov_1ln8b5ime6().s[26]++;requestStub.body={username:&#x27;test&#x27;};cov_1ln8b5ime6().s[27]++;requestStub.ip=&#x27;TEST IP&#x27;;const responseStub=(cov_1ln8b5ime6().s[28]++,sandbox.stub());const nextFake=(cov_1ln8b5ime6().s[29]++,sinon_1.fake());// Mock validation results\nconst result=(cov_1ln8b5ime6().s[30]++,sandbox.createStubInstance(express_validator_1.Result));cov_1ln8b5ime6().s[31]++;result.isEmpty.returns(true);// Stub validationResult\nconst validationResultStub=(cov_1ln8b5ime6().s[32]++,sandbox.stub(validator,&#x27;validationResult&#x27;));cov_1ln8b5ime6().s[33]++;validationResultStub.withArgs(requestStub).returns(result);cov_1ln8b5ime6().s[34]++;login_router_1.loginRouter(requestStub,responseStub,nextFake);cov_1ln8b5ime6().s[35]++;sinon_1.assert.calledOnce(nextFake);cov_1ln8b5ime6().s[36]++;sandbox.assert.calledOnce(validationResultStub);cov_1ln8b5ime6().s[37]++;sandbox.assert.calledOnce(result.isEmpty);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;171602a3-a00a-4f6d-8fd5-d86ac4db1468&quot;,&quot;parentUUID&quot;:&quot;fff4626b-ea0f-4840-9183-342288fcd41e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws InvalidRequestError if validation errors occurred&quot;,&quot;fullTitle&quot;:&quot;LoginRouter throws InvalidRequestError if validation errors occurred&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ln8b5ime6().f[5]++;const requestStub=(cov_1ln8b5ime6().s[39]++,sandbox.stub());cov_1ln8b5ime6().s[40]++;requestStub.body={username:&#x27;test&#x27;};cov_1ln8b5ime6().s[41]++;requestStub.ip=&#x27;TEST IP&#x27;;const responseStub=(cov_1ln8b5ime6().s[42]++,sandbox.stub());const nextFake=(cov_1ln8b5ime6().s[43]++,sinon_1.fake());// Mock validation results\nconst result=(cov_1ln8b5ime6().s[44]++,sandbox.createStubInstance(express_validator_1.Result));cov_1ln8b5ime6().s[45]++;result.isEmpty.returns(false);const resultArray=(cov_1ln8b5ime6().s[46]++,[{param:&#x27;first param&#x27;,msg:&#x27;first msg&#x27;},{param:&#x27;second param&#x27;,msg:&#x27;second msg&#x27;}]);cov_1ln8b5ime6().s[47]++;result.array.returns(resultArray);const expectedErrorMessage=(cov_1ln8b5ime6().s[48]++,&#x27;The following fields are invalid: &#x27;+`${resultArray[0].param} -&gt; ${resultArray[0].msg}, `+`${resultArray[1].param} -&gt; ${resultArray[1].msg}`);// Stub validationResult\nconst validationResultStub=(cov_1ln8b5ime6().s[49]++,sandbox.stub(validator,&#x27;validationResult&#x27;));cov_1ln8b5ime6().s[50]++;validationResultStub.withArgs(requestStub).returns(result);cov_1ln8b5ime6().s[51]++;chai_1.expect(()=&gt;{cov_1ln8b5ime6().f[6]++;cov_1ln8b5ime6().s[52]++;return login_router_1.loginRouter(requestStub,responseStub,nextFake);}).to.throw(errors_1.InvalidRequestError,expectedErrorMessage).with.property(&#x27;validationResult&#x27;,result);cov_1ln8b5ime6().s[53]++;sinon_1.assert.notCalled(nextFake);cov_1ln8b5ime6().s[54]++;sandbox.assert.calledOnce(validationResultStub);cov_1ln8b5ime6().s[55]++;sandbox.assert.called(result.isEmpty);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;db2fe2d5-cb4a-4791-b5b4-3f588807e60c&quot;,&quot;parentUUID&quot;:&quot;fff4626b-ea0f-4840-9183-342288fcd41e&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;171602a3-a00a-4f6d-8fd5-d86ac4db1468&quot;,&quot;db2fe2d5-cb4a-4791-b5b4-3f588807e60c&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;578bd807-e256-4443-b85f-cc6f37340125&quot;,&quot;title&quot;:&quot;SignUpController&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\signUp\\sign-up-controller.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\signUp\\sign-up-controller.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;SignUpController \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_17rd9lnwas().f[3]++;cov_17rd9lnwas().s[24]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cac67759-3871-4567-aaf8-3976a385e2d0&quot;,&quot;parentUUID&quot;:&quot;578bd807-e256-4443-b85f-cc6f37340125&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;creates user&quot;,&quot;fullTitle&quot;:&quot;SignUpController creates user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_17rd9lnwas().f[4]++;// Create fake user\nconst user=(cov_17rd9lnwas().s[26]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;password&#x27;,isBetaUser:false,get(){cov_17rd9lnwas().f[5]++;cov_17rd9lnwas().s[27]++;return this;}});const jwt=(cov_17rd9lnwas().s[28]++,{isBetaUser:user.isBetaUser,username:user.username});// Creates stubs\nconst createStub=(cov_17rd9lnwas().s[29]++,sandbox.stub(User.default,&#x27;create&#x27;));cov_17rd9lnwas().s[30]++;createStub.usingPromise(bluebird_1.default.Promise).resolves(user);const requestStub=(cov_17rd9lnwas().s[31]++,sandbox.stub());cov_17rd9lnwas().s[32]++;requestStub.body=user;const responseStub=(cov_17rd9lnwas().s[33]++,sandbox.stub());cov_17rd9lnwas().s[34]++;responseStub.status=sandbox.stub().withArgs(201).returns(responseStub);cov_17rd9lnwas().s[35]++;responseStub.setJwtToken=sinon_1.fake();cov_17rd9lnwas().s[36]++;responseStub.send=sinon_1.fake(()=&gt;{cov_17rd9lnwas().f[6]++;cov_17rd9lnwas().s[37]++;chai_1.expect(responseStub.send.called);cov_17rd9lnwas().s[38]++;sinon_1.assert.notCalled(fakeNext);cov_17rd9lnwas().s[39]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.instanceOf(user_dto_1.default));cov_17rd9lnwas().s[40]++;sandbox.assert.calledWith(responseStub.status,201);cov_17rd9lnwas().s[41]++;sandbox.assert.calledOnce(responseStub.setJwtToken);cov_17rd9lnwas().s[42]++;sandbox.assert.calledWith(responseStub.setJwtToken,sinon_1.match(jwt));// Get user object\nconst responseUser=(cov_17rd9lnwas().s[43]++,responseStub.send.args[0][0]);cov_17rd9lnwas().s[44]++;chai_1.expect(responseUser.username).to.equal(user.username);cov_17rd9lnwas().s[45]++;chai_1.expect(responseUser.email).to.equal(user.email);cov_17rd9lnwas().s[46]++;chai_1.expect(responseUser.password).to.be.undefined;cov_17rd9lnwas().s[47]++;done();});const fakeNext=(cov_17rd9lnwas().s[48]++,sinon_1.fake());cov_17rd9lnwas().s[49]++;sign_up_controller_1.default(requestStub,responseStub,fakeNext);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d8d5bca9-5108-4bfa-bab2-0b6582fb68e7&quot;,&quot;parentUUID&quot;:&quot;578bd807-e256-4443-b85f-cc6f37340125&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;fails to create user because username already exists&quot;,&quot;fullTitle&quot;:&quot;SignUpController fails to create user because username already exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_17rd9lnwas().f[7]++;const user=(cov_17rd9lnwas().s[51]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;password&#x27;,get(){cov_17rd9lnwas().f[8]++;cov_17rd9lnwas().s[52]++;return this;}});// Create stubs\nconst createStub=(cov_17rd9lnwas().s[53]++,sandbox.stub(User.default,&#x27;create&#x27;));cov_17rd9lnwas().s[54]++;createStub.usingPromise(bluebird_1.default.Promise).rejects(new sequelize_1.UniqueConstraintError());const requestStub=(cov_17rd9lnwas().s[55]++,sandbox.stub());const responseStub=(cov_17rd9lnwas().s[56]++,sandbox.stub());cov_17rd9lnwas().s[57]++;requestStub.body=user;const nextFake=(cov_17rd9lnwas().s[58]++,sinon_1.fake(err=&gt;{cov_17rd9lnwas().f[9]++;cov_17rd9lnwas().s[59]++;chai_1.expect(err).to.be.instanceOf(username_already_exists_error_1.default);cov_17rd9lnwas().s[60]++;chai_1.expect(err).to.haveOwnProperty(&#x27;username&#x27;);cov_17rd9lnwas().s[61]++;chai_1.expect(err.username).to.equal(user.username);cov_17rd9lnwas().s[62]++;done();}));cov_17rd9lnwas().s[63]++;sign_up_controller_1.default(requestStub,responseStub,nextFake);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0ee633c4-e6f6-4f9e-b556-a3c7232639ca&quot;,&quot;parentUUID&quot;:&quot;578bd807-e256-4443-b85f-cc6f37340125&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;fails to create user due to some error&quot;,&quot;fullTitle&quot;:&quot;SignUpController fails to create user due to some error&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_17rd9lnwas().f[10]++;// Fake user\nconst user=(cov_17rd9lnwas().s[65]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;,password:&#x27;password&#x27;,get(){cov_17rd9lnwas().f[11]++;cov_17rd9lnwas().s[66]++;return this;}});// Fake error\nconst error=(cov_17rd9lnwas().s[67]++,new Error(&#x27;CUSTOM ERROR&#x27;));// Create stubs\nconst createStub=(cov_17rd9lnwas().s[68]++,sandbox.stub(User.default,&#x27;create&#x27;));cov_17rd9lnwas().s[69]++;createStub.usingPromise(bluebird_1.default.Promise).rejects(error);const requestStub=(cov_17rd9lnwas().s[70]++,sandbox.stub());const responseStub=(cov_17rd9lnwas().s[71]++,sandbox.stub());cov_17rd9lnwas().s[72]++;requestStub.body=user;const nextFake=(cov_17rd9lnwas().s[73]++,sinon_1.fake(err=&gt;{cov_17rd9lnwas().f[12]++;cov_17rd9lnwas().s[74]++;chai_1.expect(err).to.be.equal(error);cov_17rd9lnwas().s[75]++;done();}));cov_17rd9lnwas().s[76]++;sign_up_controller_1.default(requestStub,responseStub,nextFake);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c94aaeb5-bc29-4fc8-b193-a2b74f4eaf45&quot;,&quot;parentUUID&quot;:&quot;578bd807-e256-4443-b85f-cc6f37340125&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d8d5bca9-5108-4bfa-bab2-0b6582fb68e7&quot;,&quot;0ee633c4-e6f6-4f9e-b556-a3c7232639ca&quot;,&quot;c94aaeb5-bc29-4fc8-b193-a2b74f4eaf45&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;6bba64d5-a541-4839-b507-06fe50471489&quot;,&quot;title&quot;:&quot;SignUpRouter&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\signUp\\sign-up-router.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\signUp\\sign-up-router.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_feqeulxi2().f[2]++;cov_feqeulxi2().s[19]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;536835ab-c129-4859-861d-fd8dfbc2e834&quot;,&quot;parentUUID&quot;:&quot;6bba64d5-a541-4839-b507-06fe50471489&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;calls next if request valid&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter calls next if request valid&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_feqeulxi2().f[3]++;// Create stubs\nconst requestStub=(cov_feqeulxi2().s[21]++,sandbox.stub());cov_feqeulxi2().s[22]++;requestStub.ip=&#x27;TEST IP&#x27;;const responseStub=(cov_feqeulxi2().s[23]++,sandbox.stub());const nextFake=(cov_feqeulxi2().s[24]++,sinon_1.fake());// Creates fake validation result\nconst validationErrors=(cov_feqeulxi2().s[25]++,sinon_1.default.createStubInstance(validator.Result));cov_feqeulxi2().s[26]++;validationErrors.isEmpty.returns(true);// Stub validator\nconst validationResultStub=(cov_feqeulxi2().s[27]++,sandbox.stub(validator,&#x27;validationResult&#x27;));cov_feqeulxi2().s[28]++;validationResultStub.withArgs(requestStub).returns(validationErrors);cov_feqeulxi2().s[29]++;sign_up_router_1.signUpRouter(requestStub,responseStub,nextFake);cov_feqeulxi2().s[30]++;sinon_1.assert.calledOnce(nextFake);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d771f81f-7c17-45fb-a46d-ceabc48336f7&quot;,&quot;parentUUID&quot;:&quot;6bba64d5-a541-4839-b507-06fe50471489&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws InvalidRequestError if request invalid&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter throws InvalidRequestError if request invalid&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_feqeulxi2().f[4]++;// Create stubs\nconst requestStub=(cov_feqeulxi2().s[32]++,sandbox.stub());cov_feqeulxi2().s[33]++;requestStub.ip=&#x27;TEST IP&#x27;;const responseStub=(cov_feqeulxi2().s[34]++,sandbox.stub());const nextFake=(cov_feqeulxi2().s[35]++,sinon_1.fake());// Creates fake validation result\nconst validationErrors=(cov_feqeulxi2().s[36]++,sinon_1.default.createStubInstance(validator.Result));cov_feqeulxi2().s[37]++;validationErrors.isEmpty.returns(false);const errorArray=(cov_feqeulxi2().s[38]++,[{param:&#x27;first param&#x27;,msg:&#x27;first reason&#x27;},{param:&#x27;second param&#x27;,msg:&#x27;second reason&#x27;}]);cov_feqeulxi2().s[39]++;validationErrors.array.returns(errorArray);// Stub validator\nconst validationResultStub=(cov_feqeulxi2().s[40]++,sandbox.stub(validator,&#x27;validationResult&#x27;));cov_feqeulxi2().s[41]++;validationResultStub.withArgs(requestStub).returns(validationErrors);const expectedMessage=(cov_feqeulxi2().s[42]++,&#x27;The following fields are invalid: &#x27;+`${errorArray[0].param} -&gt; ${errorArray[0].msg}, `+`${errorArray[1].param} -&gt; ${errorArray[1].msg}`);cov_feqeulxi2().s[43]++;chai_1.expect(()=&gt;{cov_feqeulxi2().f[5]++;cov_feqeulxi2().s[44]++;return sign_up_router_1.signUpRouter(requestStub,responseStub,nextFake);}).to.throw(errors_1.InvalidRequestError,expectedMessage).with.property(&#x27;validationResult&#x27;,validationErrors);cov_feqeulxi2().s[45]++;sinon_1.assert.notCalled(nextFake);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b64d9a5-03f5-4451-89f9-6785a939918d&quot;,&quot;parentUUID&quot;:&quot;6bba64d5-a541-4839-b507-06fe50471489&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;d771f81f-7c17-45fb-a46d-ceabc48336f7&quot;,&quot;8b64d9a5-03f5-4451-89f9-6785a939918d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;64e2bbd4-29f3-49ed-9001-791b587e589f&quot;,&quot;title&quot;:&quot;SignUpRouter&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[2]++;const csrfHeaderName=(cov_12j8vw84ob().s[12]++,config_1.default.jwt.securityOptions.tokenName.toLowerCase());cov_12j8vw84ob().s[13]++;jwt=&#x27;FAIL&#x27;;// Get csrf token\ncov_12j8vw84ob().s[14]++;csrf=await supertest_1.default(app_1.default).head(&#x27;/auth&#x27;).then(response=&gt;{cov_12j8vw84ob().f[3]++;cov_12j8vw84ob().s[15]++;// Save jwt cookie\njwt=response.header[&#x27;set-cookie&#x27;].pop().split(&#x27;;&#x27;)[0];cov_12j8vw84ob().s[16]++;return response.header[csrfHeaderName];});cov_12j8vw84ob().s[17]++;return db_1.syncPromise;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;f860ebd9-3528-462b-acc0-f90694de6170&quot;,&quot;parentUUID&quot;:&quot;64e2bbd4-29f3-49ed-9001-791b587e589f&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;creates new user&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter creates new user&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:10,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[15]++;const body=(cov_12j8vw84ob().s[55]++,{username:&#x27;demo&#x27;,password:&#x27;123456&#x27;,email:&#x27;demo@mail.com&#x27;});cov_12j8vw84ob().s[56]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(201).then(response=&gt;{cov_12j8vw84ob().f[16]++;cov_12j8vw84ob().s[57]++;chai_1.expect(response.body).to.have.property(&#x27;username&#x27;,body.username);cov_12j8vw84ob().s[58]++;chai_1.expect(response.body).to.have.property(&#x27;email&#x27;,body.email);cov_12j8vw84ob().s[59]++;chai_1.expect(response.body).to.have.not.property(&#x27;password&#x27;);cov_12j8vw84ob().s[60]++;chai_1.expect(response.body).to.have.property(&#x27;createdAt&#x27;);cov_12j8vw84ob().s[61]++;chai_1.expect(response.body).to.have.property(&#x27;updatedAt&#x27;);cov_12j8vw84ob().s[62]++;chai_1.expect(response.body).to.have.property(&#x27;deletedAt&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ba358502-b442-4174-8f5d-e6d13c976fd1&quot;,&quot;parentUUID&quot;:&quot;64e2bbd4-29f3-49ed-9001-791b587e589f&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;title&quot;:&quot;returns 400 if&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;request is missing username&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter returns 400 if request is missing username&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[5]++;const body=(cov_12j8vw84ob().s[20]++,{password:&#x27;password&#x27;,email:&#x27;demo@mail.com&#x27;});cov_12j8vw84ob().s[21]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(400).then(response=&gt;{cov_12j8vw84ob().f[6]++;cov_12j8vw84ob().s[22]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);cov_12j8vw84ob().s[23]++;chai_1.expect(response.body).to.have.property(&#x27;status&#x27;);cov_12j8vw84ob().s[24]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;);cov_12j8vw84ob().s[25]++;chai_1.expect(response.body).to.have.property(&#x27;timestamp&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;53eed5d7-ff15-4e41-b12d-9cf6e4ba377e&quot;,&quot;parentUUID&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;request is missing password&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter returns 400 if request is missing password&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[7]++;const body=(cov_12j8vw84ob().s[27]++,{username:&#x27;demo&#x27;,email:&#x27;demo@mail.com&#x27;});cov_12j8vw84ob().s[28]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(400).then(response=&gt;{cov_12j8vw84ob().f[8]++;cov_12j8vw84ob().s[29]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);cov_12j8vw84ob().s[30]++;chai_1.expect(response.body).to.have.property(&#x27;status&#x27;);cov_12j8vw84ob().s[31]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;);cov_12j8vw84ob().s[32]++;chai_1.expect(response.body).to.have.property(&#x27;timestamp&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d69ce0de-2ccd-4564-97b4-69f7e3e009d3&quot;,&quot;parentUUID&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;password is shorter than 6 characters&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter returns 400 if password is shorter than 6 characters&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[9]++;const body=(cov_12j8vw84ob().s[34]++,{username:&#x27;demo&#x27;,password:&#x27;12345&#x27;,email:&#x27;demo@mail.com&#x27;});cov_12j8vw84ob().s[35]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(400).then(response=&gt;{cov_12j8vw84ob().f[10]++;cov_12j8vw84ob().s[36]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);cov_12j8vw84ob().s[37]++;chai_1.expect(response.body).to.have.property(&#x27;status&#x27;);cov_12j8vw84ob().s[38]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;);cov_12j8vw84ob().s[39]++;chai_1.expect(response.body).to.have.property(&#x27;timestamp&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e6ae862d-8668-405d-bdca-0b92d3f8a8ec&quot;,&quot;parentUUID&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;request is missing email&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter returns 400 if request is missing email&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:7,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[11]++;const body=(cov_12j8vw84ob().s[41]++,{password:&#x27;password&#x27;,username:&#x27;demo&#x27;});cov_12j8vw84ob().s[42]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(400).then(response=&gt;{cov_12j8vw84ob().f[12]++;cov_12j8vw84ob().s[43]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);cov_12j8vw84ob().s[44]++;chai_1.expect(response.body).to.have.property(&#x27;status&#x27;);cov_12j8vw84ob().s[45]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;);cov_12j8vw84ob().s[46]++;chai_1.expect(response.body).to.have.property(&#x27;timestamp&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;bc465f12-7557-4f0d-98b5-a9df0e6bfe4c&quot;,&quot;parentUUID&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;email property is not a valid email&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter returns 400 if email property is not a valid email&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[13]++;const body=(cov_12j8vw84ob().s[48]++,{username:&#x27;demo&#x27;,password:&#x27;12345&#x27;,email:&#x27;demo&#x27;});cov_12j8vw84ob().s[49]++;return supertest_1.default(app_1.default).put(&#x27;/auth/sign-up&#x27;).set(&#x27;Cookie&#x27;,[jwt]).set(csrfHeaderName,csrf).send(body).expect(400).then(response=&gt;{cov_12j8vw84ob().f[14]++;cov_12j8vw84ob().s[50]++;chai_1.expect(response.body).to.have.property(&#x27;statusCode&#x27;,400);cov_12j8vw84ob().s[51]++;chai_1.expect(response.body).to.have.property(&#x27;status&#x27;);cov_12j8vw84ob().s[52]++;chai_1.expect(response.body).to.have.property(&#x27;message&#x27;);cov_12j8vw84ob().s[53]++;chai_1.expect(response.body).to.have.property(&#x27;timestamp&#x27;);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;66280318-7313-4811-bc15-4a5ed95c9c5a&quot;,&quot;parentUUID&quot;:&quot;b9d4c103-3d90-4a39-9228-bd19e4021fac&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;53eed5d7-ff15-4e41-b12d-9cf6e4ba377e&quot;,&quot;d69ce0de-2ccd-4564-97b4-69f7e3e009d3&quot;,&quot;e6ae862d-8668-405d-bdca-0b92d3f8a8ec&quot;,&quot;bc465f12-7557-4f0d-98b5-a9df0e6bfe4c&quot;,&quot;66280318-7313-4811-bc15-4a5ed95c9c5a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:22,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;title&quot;:&quot;responses with 401&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\auth\\signUp\\sign-up.integration.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;if request is missing a jwt token&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if request is missing a jwt token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[18]++;const body=(cov_12j8vw84ob().s[65]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[66]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(body).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a2b8435c-42f2-4db8-b7d5-5df46f39bd8e&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token exists but without secret&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if jwt token exists but without secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[19]++;const body=(cov_12j8vw84ob().s[68]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[69]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(body).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3727e182-855b-481f-bdec-662669e2103e&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if csrf header exist but no jwt&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if csrf header exist but no jwt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[20]++;const body=(cov_12j8vw84ob().s[71]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[72]++;jwt=jsonwebtoken_1.default.sign({username:&#x27;username&#x27;},config_1.default.jwt.secret,config_1.default.jwt.getOptions());cov_12j8vw84ob().s[73]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).send(body).set(&#x27;Cookie&#x27;,[jwt]).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2159ada3-5dbb-46ea-ab3a-f2a959901612&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token with secret exists but no header for the csrf token&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if jwt token with secret exists but no header for the csrf token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[21]++;const body=(cov_12j8vw84ob().s[75]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[76]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(&#x27;Cookie&#x27;,[jwt]).send(body).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;90440440-e01e-4756-ae47-66e130e44aa4&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token and csrf header exist, but jwt token has no secret&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if jwt token and csrf header exist, but jwt token has no secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[22]++;const body=(cov_12j8vw84ob().s[78]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[79]++;jwt=jsonwebtoken_1.default.sign({username:&#x27;username&#x27;},config_1.default.jwt.secret,config_1.default.jwt.getOptions());cov_12j8vw84ob().s[80]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,csrf).set(&#x27;Cookie&#x27;,[jwt]).send(body).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dc9c8558-940d-4956-b729-d1a8a4eec35e&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;if jwt token with secret and csrf header exist, but they don&#x27;t belong together&quot;,&quot;fullTitle&quot;:&quot;SignUpRouter responses with 401 if jwt token with secret and csrf header exist, but they don&#x27;t belong together&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_12j8vw84ob().f[23]++;const body=(cov_12j8vw84ob().s[82]++,{username:&#x27;test&#x27;,password:&#x27;testPassword&#x27;});cov_12j8vw84ob().s[83]++;return supertest_1.default(app_1.default).put(&#x27;/auth/login&#x27;).set(csrfHeaderName,&#x27;FAIL&#x27;).set(&#x27;Cookie&#x27;,[jwt]).send(body).expect(401);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4da77a6e-9139-4132-a484-f4d6b64307a0&quot;,&quot;parentUUID&quot;:&quot;1d66baa0-930c-4f24-bb96-391a2fc7e936&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;a2b8435c-42f2-4db8-b7d5-5df46f39bd8e&quot;,&quot;3727e182-855b-481f-bdec-662669e2103e&quot;,&quot;2159ada3-5dbb-46ea-ab3a-f2a959901612&quot;,&quot;90440440-e01e-4756-ae47-66e130e44aa4&quot;,&quot;dc9c8558-940d-4956-b729-d1a8a4eec35e&quot;,&quot;4da77a6e-9139-4132-a484-f4d6b64307a0&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:16,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[&quot;ba358502-b442-4174-8f5d-e6d13c976fd1&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:10,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;aae0d63f-2a3f-4d6b-bcc9-3e07c4dd79d9&quot;,&quot;title&quot;:&quot;ErrorHandler&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\errors\\error-handler.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\errors\\error-handler.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;ErrorHandler \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_mn39xzspr().f[3]++;cov_mn39xzspr().s[23]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b6f8f27-495b-49e6-b26b-c0d8506eb720&quot;,&quot;parentUUID&quot;:&quot;aae0d63f-2a3f-4d6b-bcc9-3e07c4dd79d9&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[{&quot;title&quot;:&quot;throws specific Error if instanceof RestError&quot;,&quot;fullTitle&quot;:&quot;ErrorHandler throws specific Error if instanceof RestError&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:3,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_mn39xzspr().f[4]++;// Spy and stub\nconst responseStub=(cov_mn39xzspr().s[25]++,sandbox.stub());const requestStub=(cov_mn39xzspr().s[26]++,sandbox.stub());const nextStub=(cov_mn39xzspr().s[27]++,sinon_1.default.stub());const validationResultStub=(cov_mn39xzspr().s[28]++,sandbox.createStubInstance(express_validator_1.Result));// Stub methods\ncov_mn39xzspr().s[29]++;validationResultStub.isEmpty.returns(true);cov_mn39xzspr().s[30]++;responseStub.status=sandbox.stub().returns(responseStub);cov_mn39xzspr().s[31]++;responseStub.send=sandbox.stub();// Test\nconst error=(cov_mn39xzspr().s[32]++,new invalid_request_error_1.default(validationResultStub));cov_mn39xzspr().s[33]++;error_handler_1.default(error,requestStub,responseStub,nextStub);cov_mn39xzspr().s[34]++;sandbox.assert.notCalled(requestStub);cov_mn39xzspr().s[35]++;sandbox.assert.calledOnce(validationResultStub.isEmpty);cov_mn39xzspr().s[36]++;sandbox.assert.calledOnce(responseStub.status);cov_mn39xzspr().s[37]++;sandbox.assert.calledOnce(responseStub.send);cov_mn39xzspr().s[38]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.instanceOf(rest_error_1.default));cov_mn39xzspr().s[39]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;message&#x27;,error.message));cov_mn39xzspr().s[40]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;timestamp&#x27;,sinon_1.match.date));cov_mn39xzspr().s[41]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;statusCode&#x27;,error.statusCode));cov_mn39xzspr().s[42]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;detail&#x27;,error.detail));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c8a18708-1fe5-4db8-a72c-816e32bd9a03&quot;,&quot;parentUUID&quot;:&quot;aae0d63f-2a3f-4d6b-bcc9-3e07c4dd79d9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws InternalError if not instanceof RestError&quot;,&quot;fullTitle&quot;:&quot;ErrorHandler throws InternalError if not instanceof RestError&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_mn39xzspr().f[5]++;// Spy and stub\nconst responseStub=(cov_mn39xzspr().s[44]++,sandbox.stub());const requestStub=(cov_mn39xzspr().s[45]++,sandbox.stub());const nextStub=(cov_mn39xzspr().s[46]++,sandbox.stub());// Stub methods\ncov_mn39xzspr().s[47]++;responseStub.status=sandbox.stub().returns(responseStub);cov_mn39xzspr().s[48]++;responseStub.send=sandbox.stub();// Test\nconst error=(cov_mn39xzspr().s[49]++,new Error());const stack=(cov_mn39xzspr().s[50]++,&#x27;SOME STACK&#x27;);cov_mn39xzspr().s[51]++;error.stack=stack;cov_mn39xzspr().s[52]++;error_handler_1.default(error,requestStub,responseStub,nextStub);cov_mn39xzspr().s[53]++;sandbox.assert.notCalled(requestStub);cov_mn39xzspr().s[54]++;sandbox.assert.calledOnce(responseStub.status);cov_mn39xzspr().s[55]++;sandbox.assert.calledOnce(responseStub.send);cov_mn39xzspr().s[56]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.instanceOf(internal_error_1.default));cov_mn39xzspr().s[57]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;stack&#x27;,stack));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;211221f8-afda-4fc4-9400-3408c8590426&quot;,&quot;parentUUID&quot;:&quot;aae0d63f-2a3f-4d6b-bcc9-3e07c4dd79d9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws InternalError without stack if environment is production&quot;,&quot;fullTitle&quot;:&quot;ErrorHandler throws InternalError without stack if environment is production&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_mn39xzspr().f[6]++;cov_mn39xzspr().s[59]++;config.default.error.withStack=false;// Spy and stub\nconst responseStub=(cov_mn39xzspr().s[60]++,sandbox.stub());const requestStub=(cov_mn39xzspr().s[61]++,sandbox.stub());const nextStub=(cov_mn39xzspr().s[62]++,sandbox.stub());// Stub methods\ncov_mn39xzspr().s[63]++;responseStub.status=sandbox.stub().returns(responseStub);cov_mn39xzspr().s[64]++;responseStub.send=sandbox.stub();// Test\nconst error=(cov_mn39xzspr().s[65]++,new Error());cov_mn39xzspr().s[66]++;error_handler_1.default(error,requestStub,responseStub,nextStub);cov_mn39xzspr().s[67]++;sandbox.assert.notCalled(requestStub);cov_mn39xzspr().s[68]++;sandbox.assert.calledOnce(responseStub.status);cov_mn39xzspr().s[69]++;sandbox.assert.calledOnce(responseStub.send);cov_mn39xzspr().s[70]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.instanceOf(internal_error_1.default));cov_mn39xzspr().s[71]++;sandbox.assert.calledWith(responseStub.send,sinon_1.match.has(&#x27;stack&#x27;,undefined));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;433cedf3-41b4-4e4f-8456-12a762ce90e4&quot;,&quot;parentUUID&quot;:&quot;aae0d63f-2a3f-4d6b-bcc9-3e07c4dd79d9&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;c8a18708-1fe5-4db8-a72c-816e32bd9a03&quot;,&quot;211221f8-afda-4fc4-9400-3408c8590426&quot;,&quot;433cedf3-41b4-4e4f-8456-12a762ce90e4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:7,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;a34d3300-8545-4522-a326-8d683a404d20&quot;,&quot;title&quot;:&quot;jwt-csrf&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[3]++;cov_1ighra4x6r().s[28]++;jwtCsrfHandler=jwt_csrf_1.default();/**\n         * Stub verify method of jsonwebtoken to return given jwtToken\n         */cov_1ighra4x6r().s[29]++;jwtVerifyStub=sandbox.stub(jsonwebtoken_1.default,&#x27;verify&#x27;).callsFake(token=&gt;{cov_1ighra4x6r().f[4]++;cov_1ighra4x6r().s[30]++;return token;});cov_1ighra4x6r().s[31]++;response=sandbox.stub();cov_1ighra4x6r().s[32]++;request=sandbox.stub();cov_1ighra4x6r().s[33]++;next=sandbox.stub();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;25bfba47-78be-4791-bd12-26d30168e0e4&quot;,&quot;parentUUID&quot;:&quot;a34d3300-8545-4522-a326-8d683a404d20&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[5]++;cov_1ighra4x6r().s[35]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c79b22c4-8c5a-4d87-975c-e6b40932fa3e&quot;,&quot;parentUUID&quot;:&quot;a34d3300-8545-4522-a326-8d683a404d20&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;title&quot;:&quot;with not ignored method \&quot;PUT\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[8]++;cov_1ighra4x6r().s[39]++;request.method=method;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;86beefc4-301b-4a75-8c0b-13209a08e698&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[9]++;cov_1ighra4x6r().s[41]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[42]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[43]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[10]++;cov_1ighra4x6r().s[44]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[45]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[46]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[47]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;707fc168-f4f9-4016-9f5e-acfad00d136b&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[11]++;cov_1ighra4x6r().s[49]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[50]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[51]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[52]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[12]++;cov_1ighra4x6r().s[53]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[54]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[55]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[56]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ecdc927-3d45-4b6d-8249-9c53ca522490&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if jwt has no secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[13]++;cov_1ighra4x6r().s[58]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[59]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[60]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[14]++;cov_1ighra4x6r().s[61]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[62]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[63]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;c793b473-d456-4747-810f-8f5c1bcf241c&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[15]++;cov_1ighra4x6r().s[65]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[66]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[67]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[68]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[16]++;cov_1ighra4x6r().s[69]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[70]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[71]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2f32948b-c10c-49f4-83a0-06458592b9ed&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[17]++;cov_1ighra4x6r().s[73]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(undefined);cov_1ighra4x6r().s[74]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});cov_1ighra4x6r().s[75]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[76]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[18]++;cov_1ighra4x6r().s[77]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[78]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[79]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a84fa71c-9b17-46a6-a747-d102be6ddeed&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[19]++;cov_1ighra4x6r().s[81]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[82]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[83]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(false);cov_1ighra4x6r().s[84]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[20]++;cov_1ighra4x6r().s[85]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[86]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8276aa88-2120-4cb4-af21-eefb0e2ba2f6&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with token and csrf header exist and belong together&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; calls next if jwt with token and csrf header exist and belong together&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[21]++;const token=(cov_1ighra4x6r().s[88]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[89]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[90]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[91]++,{[secretName]:secret});cov_1ighra4x6r().s[92]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[93]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);cov_1ighra4x6r().s[94]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[95]++;sandbox.assert.calledOnce(jwtVerifyStub);cov_1ighra4x6r().s[96]++;sandbox.assert.calledWith(jwtVerifyStub,sinon_1.match(jwt),config_1.default.jwt.secret);cov_1ighra4x6r().s[97]++;sandbox.assert.calledOnce(tokenVerifyStub);cov_1ighra4x6r().s[98]++;sandbox.assert.calledWith(tokenVerifyStub,secret,token);cov_1ighra4x6r().s[99]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1f0b7a41-4f78-4eb9-83e8-26da12a5e86b&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getCsrfToken returns the sent token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; getCsrfToken returns the sent token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[22]++;const token=(cov_1ighra4x6r().s[101]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[102]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[103]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[104]++,{[secretName]:secret});cov_1ighra4x6r().s[105]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[106]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[107]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[108]++;chai_1.expect(request).to.have.ownProperty(&#x27;getCsrfToken&#x27;);cov_1ighra4x6r().s[109]++;chai_1.expect(request.getCsrfToken()).to.be.equal(token);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0ad05d81-78ec-453d-9446-ac7b16bcaa9e&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;setJwtToken sets a new jwt cookie&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; setJwtToken sets a new jwt cookie&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[23]++;const token=(cov_1ighra4x6r().s[111]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[112]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);/**\n                 * Stub settings of an cookie to return name, content and options\n                 */cov_1ighra4x6r().s[113]++;response.cookie=sinon_1.fake();/**\n                 * Stub generateToken method to return payload and subject\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[114]++,&#x27;GENERATED&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[115]++,sandbox.stub(util,&#x27;generateToken&#x27;).callsFake(()=&gt;{cov_1ighra4x6r().f[24]++;cov_1ighra4x6r().s[116]++;return generateTokenReturnValue;}));const secret=(cov_1ighra4x6r().s[117]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[118]++,{[secretName]:secret});cov_1ighra4x6r().s[119]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[120]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[121]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[122]++;chai_1.expect(response).to.have.ownProperty(&#x27;setJwtToken&#x27;);const payload=(cov_1ighra4x6r().s[123]++,{username:&#x27;TEST&#x27;,test:true});const expectedNewPayload=(cov_1ighra4x6r().s[124]++,{username:payload.username,test:payload.test,[secretName]:secret});const subject=(cov_1ighra4x6r().s[125]++,&#x27;SUBJECT&#x27;);cov_1ighra4x6r().s[126]++;response.setJwtToken(payload,subject);cov_1ighra4x6r().s[127]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[128]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match(expectedNewPayload),subject);cov_1ighra4x6r().s[129]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[130]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue,config_1.default.jwt.cookieOptions);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;312df799-20dc-467a-8767-f77b8b4446e9&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getSecret returns the secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PUT\&quot; getSecret returns the secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[25]++;const token=(cov_1ighra4x6r().s[132]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[133]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[134]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[135]++,{[secretName]:secret});cov_1ighra4x6r().s[136]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[137]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[138]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[139]++;chai_1.expect(request).to.have.ownProperty(&#x27;getSecret&#x27;);cov_1ighra4x6r().s[140]++;chai_1.expect(request.getSecret()).to.be.equal(secret);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;58bdaea1-ee34-45e4-be88-45c33c4c9d42&quot;,&quot;parentUUID&quot;:&quot;c0bac694-b527-4831-b622-e0d5da0c15e8&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;707fc168-f4f9-4016-9f5e-acfad00d136b&quot;,&quot;2ecdc927-3d45-4b6d-8249-9c53ca522490&quot;,&quot;c793b473-d456-4747-810f-8f5c1bcf241c&quot;,&quot;2f32948b-c10c-49f4-83a0-06458592b9ed&quot;,&quot;a84fa71c-9b17-46a6-a747-d102be6ddeed&quot;,&quot;8276aa88-2120-4cb4-af21-eefb0e2ba2f6&quot;,&quot;1f0b7a41-4f78-4eb9-83e8-26da12a5e86b&quot;,&quot;0ad05d81-78ec-453d-9446-ac7b16bcaa9e&quot;,&quot;312df799-20dc-467a-8767-f77b8b4446e9&quot;,&quot;58bdaea1-ee34-45e4-be88-45c33c4c9d42&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:12,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;title&quot;:&quot;with not ignored method \&quot;POST\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[8]++;cov_1ighra4x6r().s[39]++;request.method=method;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4b53e314-dac1-4a4b-9677-79758dbdd19d&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[9]++;cov_1ighra4x6r().s[41]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[42]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[43]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[10]++;cov_1ighra4x6r().s[44]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[45]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[46]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[47]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;af2a6d55-ae76-45b7-bcee-7d072ebf43f1&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[11]++;cov_1ighra4x6r().s[49]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[50]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[51]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[52]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[12]++;cov_1ighra4x6r().s[53]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[54]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[55]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[56]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;2ba88780-f627-426c-9ec6-b0b4af0112ad&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if jwt has no secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[13]++;cov_1ighra4x6r().s[58]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[59]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[60]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[14]++;cov_1ighra4x6r().s[61]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[62]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[63]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;63f0340e-0f45-4a70-bc7d-54797d03279a&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[15]++;cov_1ighra4x6r().s[65]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[66]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[67]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[68]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[16]++;cov_1ighra4x6r().s[69]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[70]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[71]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5a70f729-3d8d-42fc-bd27-0b57c27d4583&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[17]++;cov_1ighra4x6r().s[73]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(undefined);cov_1ighra4x6r().s[74]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});cov_1ighra4x6r().s[75]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[76]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[18]++;cov_1ighra4x6r().s[77]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[78]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[79]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;baccecee-ff50-4365-bf33-2e3e4251beec&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[19]++;cov_1ighra4x6r().s[81]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[82]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[83]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(false);cov_1ighra4x6r().s[84]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[20]++;cov_1ighra4x6r().s[85]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[86]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59771ff8-b8d5-45e4-81ec-a6eeec16aee8&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with token and csrf header exist and belong together&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; calls next if jwt with token and csrf header exist and belong together&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[21]++;const token=(cov_1ighra4x6r().s[88]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[89]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[90]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[91]++,{[secretName]:secret});cov_1ighra4x6r().s[92]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[93]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);cov_1ighra4x6r().s[94]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[95]++;sandbox.assert.calledOnce(jwtVerifyStub);cov_1ighra4x6r().s[96]++;sandbox.assert.calledWith(jwtVerifyStub,sinon_1.match(jwt),config_1.default.jwt.secret);cov_1ighra4x6r().s[97]++;sandbox.assert.calledOnce(tokenVerifyStub);cov_1ighra4x6r().s[98]++;sandbox.assert.calledWith(tokenVerifyStub,secret,token);cov_1ighra4x6r().s[99]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0b3a1255-73ff-4703-92b0-6e1c7b674a3c&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getCsrfToken returns the sent token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; getCsrfToken returns the sent token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[22]++;const token=(cov_1ighra4x6r().s[101]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[102]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[103]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[104]++,{[secretName]:secret});cov_1ighra4x6r().s[105]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[106]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[107]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[108]++;chai_1.expect(request).to.have.ownProperty(&#x27;getCsrfToken&#x27;);cov_1ighra4x6r().s[109]++;chai_1.expect(request.getCsrfToken()).to.be.equal(token);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;01165d1f-bb4a-49d7-b766-250fe7f64be5&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;setJwtToken sets a new jwt cookie&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; setJwtToken sets a new jwt cookie&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[23]++;const token=(cov_1ighra4x6r().s[111]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[112]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);/**\n                 * Stub settings of an cookie to return name, content and options\n                 */cov_1ighra4x6r().s[113]++;response.cookie=sinon_1.fake();/**\n                 * Stub generateToken method to return payload and subject\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[114]++,&#x27;GENERATED&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[115]++,sandbox.stub(util,&#x27;generateToken&#x27;).callsFake(()=&gt;{cov_1ighra4x6r().f[24]++;cov_1ighra4x6r().s[116]++;return generateTokenReturnValue;}));const secret=(cov_1ighra4x6r().s[117]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[118]++,{[secretName]:secret});cov_1ighra4x6r().s[119]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[120]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[121]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[122]++;chai_1.expect(response).to.have.ownProperty(&#x27;setJwtToken&#x27;);const payload=(cov_1ighra4x6r().s[123]++,{username:&#x27;TEST&#x27;,test:true});const expectedNewPayload=(cov_1ighra4x6r().s[124]++,{username:payload.username,test:payload.test,[secretName]:secret});const subject=(cov_1ighra4x6r().s[125]++,&#x27;SUBJECT&#x27;);cov_1ighra4x6r().s[126]++;response.setJwtToken(payload,subject);cov_1ighra4x6r().s[127]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[128]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match(expectedNewPayload),subject);cov_1ighra4x6r().s[129]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[130]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue,config_1.default.jwt.cookieOptions);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;545ad87f-127a-4fb4-8df1-3d06bccc4c5d&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getSecret returns the secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;POST\&quot; getSecret returns the secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[25]++;const token=(cov_1ighra4x6r().s[132]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[133]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[134]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[135]++,{[secretName]:secret});cov_1ighra4x6r().s[136]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[137]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[138]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[139]++;chai_1.expect(request).to.have.ownProperty(&#x27;getSecret&#x27;);cov_1ighra4x6r().s[140]++;chai_1.expect(request.getSecret()).to.be.equal(secret);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;969753fa-de51-45dd-9ade-2aaafb6606d5&quot;,&quot;parentUUID&quot;:&quot;58eda683-3b9c-4401-8dfd-8ef9ff5f6404&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;af2a6d55-ae76-45b7-bcee-7d072ebf43f1&quot;,&quot;2ba88780-f627-426c-9ec6-b0b4af0112ad&quot;,&quot;63f0340e-0f45-4a70-bc7d-54797d03279a&quot;,&quot;5a70f729-3d8d-42fc-bd27-0b57c27d4583&quot;,&quot;baccecee-ff50-4365-bf33-2e3e4251beec&quot;,&quot;59771ff8-b8d5-45e4-81ec-a6eeec16aee8&quot;,&quot;0b3a1255-73ff-4703-92b0-6e1c7b674a3c&quot;,&quot;01165d1f-bb4a-49d7-b766-250fe7f64be5&quot;,&quot;545ad87f-127a-4fb4-8df1-3d06bccc4c5d&quot;,&quot;969753fa-de51-45dd-9ade-2aaafb6606d5&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:6,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;title&quot;:&quot;with not ignored method \&quot;PATCH\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[8]++;cov_1ighra4x6r().s[39]++;request.method=method;&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;adbed0cb-54d5-4ed2-8c44-3b37836cceae&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[9]++;cov_1ighra4x6r().s[41]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[42]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[43]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[10]++;cov_1ighra4x6r().s[44]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[45]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[46]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[47]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7276d0e8-ab54-4784-8269-178bf7874378&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if no jwt exists but the csrf header&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[11]++;cov_1ighra4x6r().s[49]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[50]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);cov_1ighra4x6r().s[51]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[52]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[12]++;cov_1ighra4x6r().s[53]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[54]++;sandbox.assert.notCalled(jwtVerifyStub);cov_1ighra4x6r().s[55]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[56]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;83e01556-8a4c-4227-9655-3255e43962e3&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if jwt has no secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[13]++;cov_1ighra4x6r().s[58]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[59]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[60]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[14]++;cov_1ighra4x6r().s[61]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[62]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[63]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;04fb9ac7-96a0-48ee-afe4-de2557af7061&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if jwt has no secret but the csrf header exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[15]++;cov_1ighra4x6r().s[65]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[66]++;config_1.default.jwt.getToken=sandbox.stub().returns({});cov_1ighra4x6r().s[67]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[68]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[16]++;cov_1ighra4x6r().s[69]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[70]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[71]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7c7f138e-62c5-48d8-89e7-e455bf963482&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if jwt exists on request but csrf header not&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[17]++;cov_1ighra4x6r().s[73]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(undefined);cov_1ighra4x6r().s[74]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});cov_1ighra4x6r().s[75]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;);cov_1ighra4x6r().s[76]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[18]++;cov_1ighra4x6r().s[77]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[78]++;sandbox.assert.notCalled(tokenVerifyStub);cov_1ighra4x6r().s[79]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;778c3647-fe80-4c3f-84f8-453c0b4b9f81&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; throws UnauthorizedError if jwtand csrf header exist but secret doesn&#x27;t belong to token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[19]++;cov_1ighra4x6r().s[81]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(&#x27;TEST&#x27;);cov_1ighra4x6r().s[82]++;config_1.default.jwt.getToken=sandbox.stub().returns({[secretName]:&#x27;TEST&#x27;});/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[83]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(false);cov_1ighra4x6r().s[84]++;chai_1.expect(()=&gt;{cov_1ighra4x6r().f[20]++;cov_1ighra4x6r().s[85]++;return jwtCsrfHandler(request,response,next);}).to.throw(unauthorized_error_1.default);cov_1ighra4x6r().s[86]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;d125859f-09db-46cd-aba4-b96454dcf100&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with token and csrf header exist and belong together&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; calls next if jwt with token and csrf header exist and belong together&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[21]++;const token=(cov_1ighra4x6r().s[88]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[89]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[90]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[91]++,{[secretName]:secret});cov_1ighra4x6r().s[92]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[93]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);cov_1ighra4x6r().s[94]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[95]++;sandbox.assert.calledOnce(jwtVerifyStub);cov_1ighra4x6r().s[96]++;sandbox.assert.calledWith(jwtVerifyStub,sinon_1.match(jwt),config_1.default.jwt.secret);cov_1ighra4x6r().s[97]++;sandbox.assert.calledOnce(tokenVerifyStub);cov_1ighra4x6r().s[98]++;sandbox.assert.calledWith(tokenVerifyStub,secret,token);cov_1ighra4x6r().s[99]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;dc2617d6-1b4f-4b3c-9752-b0379ac7c762&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getCsrfToken returns the sent token&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; getCsrfToken returns the sent token&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[22]++;const token=(cov_1ighra4x6r().s[101]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[102]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[103]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[104]++,{[secretName]:secret});cov_1ighra4x6r().s[105]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[106]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[107]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[108]++;chai_1.expect(request).to.have.ownProperty(&#x27;getCsrfToken&#x27;);cov_1ighra4x6r().s[109]++;chai_1.expect(request.getCsrfToken()).to.be.equal(token);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;19761db9-b781-4fe5-9dac-11f6597bada9&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;setJwtToken sets a new jwt cookie&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; setJwtToken sets a new jwt cookie&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[23]++;const token=(cov_1ighra4x6r().s[111]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[112]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);/**\n                 * Stub settings of an cookie to return name, content and options\n                 */cov_1ighra4x6r().s[113]++;response.cookie=sinon_1.fake();/**\n                 * Stub generateToken method to return payload and subject\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[114]++,&#x27;GENERATED&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[115]++,sandbox.stub(util,&#x27;generateToken&#x27;).callsFake(()=&gt;{cov_1ighra4x6r().f[24]++;cov_1ighra4x6r().s[116]++;return generateTokenReturnValue;}));const secret=(cov_1ighra4x6r().s[117]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[118]++,{[secretName]:secret});cov_1ighra4x6r().s[119]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[120]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[121]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[122]++;chai_1.expect(response).to.have.ownProperty(&#x27;setJwtToken&#x27;);const payload=(cov_1ighra4x6r().s[123]++,{username:&#x27;TEST&#x27;,test:true});const expectedNewPayload=(cov_1ighra4x6r().s[124]++,{username:payload.username,test:payload.test,[secretName]:secret});const subject=(cov_1ighra4x6r().s[125]++,&#x27;SUBJECT&#x27;);cov_1ighra4x6r().s[126]++;response.setJwtToken(payload,subject);cov_1ighra4x6r().s[127]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[128]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match(expectedNewPayload),subject);cov_1ighra4x6r().s[129]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[130]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue,config_1.default.jwt.cookieOptions);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;7cb12d93-67eb-406c-9a55-947e08cd0dc5&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;getSecret returns the secret&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with not ignored method \&quot;PATCH\&quot; getSecret returns the secret&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[25]++;const token=(cov_1ighra4x6r().s[132]++,&#x27;TOKEN&#x27;);cov_1ighra4x6r().s[133]++;request.get=sandbox.stub().withArgs(csrfHeaderName).returns(token);const secret=(cov_1ighra4x6r().s[134]++,&#x27;SECRET&#x27;);const jwt=(cov_1ighra4x6r().s[135]++,{[secretName]:secret});cov_1ighra4x6r().s[136]++;config_1.default.jwt.getToken=sandbox.stub().returns(jwt);/**\n                 * Stub verify method of tokens to return true\n                 * if secret and token are equal.\n                 */cov_1ighra4x6r().s[137]++;tokenVerifyStub=sandbox.stub(csrf_1.default.prototype,&#x27;verify&#x27;).returns(true);// Call handler with jwt and token\ncov_1ighra4x6r().s[138]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[139]++;chai_1.expect(request).to.have.ownProperty(&#x27;getSecret&#x27;);cov_1ighra4x6r().s[140]++;chai_1.expect(request.getSecret()).to.be.equal(secret);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1068dfd1-fcda-4142-8157-bc78ebcd7c72&quot;,&quot;parentUUID&quot;:&quot;4b62715d-a057-449d-a8c0-d2d9b5f44411&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;7276d0e8-ab54-4784-8269-178bf7874378&quot;,&quot;83e01556-8a4c-4227-9655-3255e43962e3&quot;,&quot;04fb9ac7-96a0-48ee-afe4-de2557af7061&quot;,&quot;7c7f138e-62c5-48d8-89e7-e455bf963482&quot;,&quot;778c3647-fe80-4c3f-84f8-453c0b4b9f81&quot;,&quot;d125859f-09db-46cd-aba4-b96454dcf100&quot;,&quot;dc2617d6-1b4f-4b3c-9752-b0379ac7c762&quot;,&quot;19761db9-b781-4fe5-9dac-11f6597bada9&quot;,&quot;7cb12d93-67eb-406c-9a55-947e08cd0dc5&quot;,&quot;1068dfd1-fcda-4142-8157-bc78ebcd7c72&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:8,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;339f2e6e-6458-4800-8fe8-34f6ad492bfb&quot;,&quot;title&quot;:&quot;with ignored method \&quot;GET\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;GET\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[28]++;cov_1ighra4x6r().s[144]++;request.method=method;cov_1ighra4x6r().s[145]++;response.cookie=sandbox.stub();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;109ff7bc-cedb-4708-b531-b44425a34ac3&quot;,&quot;parentUUID&quot;:&quot;339f2e6e-6458-4800-8fe8-34f6ad492bfb&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;creates new jwt with just the secret if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;GET\&quot; creates new jwt with just the secret if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[29]++;cov_1ighra4x6r().s[147]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[148]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[149]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[150]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[151]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[152]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[153]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[154]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[155]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[156]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[157]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[158]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b44ae05-3529-4c91-959b-4efb3dc757dc&quot;,&quot;parentUUID&quot;:&quot;339f2e6e-6458-4800-8fe8-34f6ad492bfb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates new jwt if jwt exists but is missing secret field&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;GET\&quot; creates new jwt if jwt exists but is missing secret field&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[30]++;const jwt=(cov_1ighra4x6r().s[160]++,{username:&#x27;TEST&#x27;});cov_1ighra4x6r().s[161]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[162]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[163]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[164]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[165]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[166]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[167]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[168]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[169]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[170]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[171]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[172]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ef3f473b-91b9-4ca1-8f13-1ef74fd8f879&quot;,&quot;parentUUID&quot;:&quot;339f2e6e-6458-4800-8fe8-34f6ad492bfb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with secret exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;GET\&quot; calls next if jwt with secret exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[31]++;/**\n                 * Stub generateToken method.\n                 */const generateTokenStub=(cov_1ighra4x6r().s[174]++,sandbox.stub(util,&#x27;generateToken&#x27;));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[175]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[176]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;));const jwt=(cov_1ighra4x6r().s[177]++,{[secretName]:secret});cov_1ighra4x6r().s[178]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);cov_1ighra4x6r().s[179]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[180]++;sandbox.assert.notCalled(secretSyncStub);cov_1ighra4x6r().s[181]++;sandbox.assert.notCalled(generateTokenStub);cov_1ighra4x6r().s[182]++;sandbox.assert.notCalled(response.cookie);cov_1ighra4x6r().s[183]++;sandbox.assert.calledOnce(config_1.default.jwt.getToken);cov_1ighra4x6r().s[184]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;cc8bac18-a543-48f0-8d09-0d4ce889d803&quot;,&quot;parentUUID&quot;:&quot;339f2e6e-6458-4800-8fe8-34f6ad492bfb&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8b44ae05-3529-4c91-959b-4efb3dc757dc&quot;,&quot;ef3f473b-91b9-4ca1-8f13-1ef74fd8f879&quot;,&quot;cc8bac18-a543-48f0-8d09-0d4ce889d803&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;3655d9dc-1035-4789-bec9-874df3901855&quot;,&quot;title&quot;:&quot;with ignored method \&quot;HEAD\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;HEAD\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[28]++;cov_1ighra4x6r().s[144]++;request.method=method;cov_1ighra4x6r().s[145]++;response.cookie=sandbox.stub();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;1fdd46a5-f99f-4fe5-8614-d3d7de0b2b27&quot;,&quot;parentUUID&quot;:&quot;3655d9dc-1035-4789-bec9-874df3901855&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;creates new jwt with just the secret if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;HEAD\&quot; creates new jwt with just the secret if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[29]++;cov_1ighra4x6r().s[147]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[148]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[149]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[150]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[151]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[152]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[153]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[154]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[155]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[156]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[157]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[158]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3f22ddbc-136b-479f-a67f-0cead7863fce&quot;,&quot;parentUUID&quot;:&quot;3655d9dc-1035-4789-bec9-874df3901855&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates new jwt if jwt exists but is missing secret field&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;HEAD\&quot; creates new jwt if jwt exists but is missing secret field&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[30]++;const jwt=(cov_1ighra4x6r().s[160]++,{username:&#x27;TEST&#x27;});cov_1ighra4x6r().s[161]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[162]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[163]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[164]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[165]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[166]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[167]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[168]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[169]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[170]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[171]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[172]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8b009f07-c806-44a9-99b2-ab10fbccf454&quot;,&quot;parentUUID&quot;:&quot;3655d9dc-1035-4789-bec9-874df3901855&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with secret exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;HEAD\&quot; calls next if jwt with secret exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[31]++;/**\n                 * Stub generateToken method.\n                 */const generateTokenStub=(cov_1ighra4x6r().s[174]++,sandbox.stub(util,&#x27;generateToken&#x27;));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[175]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[176]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;));const jwt=(cov_1ighra4x6r().s[177]++,{[secretName]:secret});cov_1ighra4x6r().s[178]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);cov_1ighra4x6r().s[179]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[180]++;sandbox.assert.notCalled(secretSyncStub);cov_1ighra4x6r().s[181]++;sandbox.assert.notCalled(generateTokenStub);cov_1ighra4x6r().s[182]++;sandbox.assert.notCalled(response.cookie);cov_1ighra4x6r().s[183]++;sandbox.assert.calledOnce(config_1.default.jwt.getToken);cov_1ighra4x6r().s[184]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;239a94e3-857a-475f-bba5-62d315301e67&quot;,&quot;parentUUID&quot;:&quot;3655d9dc-1035-4789-bec9-874df3901855&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;3f22ddbc-136b-479f-a67f-0cead7863fce&quot;,&quot;8b009f07-c806-44a9-99b2-ab10fbccf454&quot;,&quot;239a94e3-857a-475f-bba5-62d315301e67&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;83390ddc-61d3-44ad-99a8-c269048c1088&quot;,&quot;title&quot;:&quot;with ignored method \&quot;OPTIONS\&quot;&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-csrf.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;OPTIONS\&quot; \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[28]++;cov_1ighra4x6r().s[144]++;request.method=method;cov_1ighra4x6r().s[145]++;response.cookie=sandbox.stub();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;56721b64-1893-42c0-b5d4-7af5feb0ad3b&quot;,&quot;parentUUID&quot;:&quot;83390ddc-61d3-44ad-99a8-c269048c1088&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;creates new jwt with just the secret if no jwt exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;OPTIONS\&quot; creates new jwt with just the secret if no jwt exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[29]++;cov_1ighra4x6r().s[147]++;config_1.default.jwt.getToken=sandbox.stub().returns(null);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[148]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[149]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[150]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[151]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[152]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[153]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[154]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[155]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[156]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[157]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[158]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;e0d7c26a-02dc-48aa-a045-d7ba04dfbdec&quot;,&quot;parentUUID&quot;:&quot;83390ddc-61d3-44ad-99a8-c269048c1088&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;creates new jwt if jwt exists but is missing secret field&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;OPTIONS\&quot; creates new jwt if jwt exists but is missing secret field&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[30]++;const jwt=(cov_1ighra4x6r().s[160]++,{username:&#x27;TEST&#x27;});cov_1ighra4x6r().s[161]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);/**\n                 * Stub generateToken method.\n                 */const generateTokenReturnValue=(cov_1ighra4x6r().s[162]++,&#x27;GENERATE_TOKEN&#x27;);const generateTokenStub=(cov_1ighra4x6r().s[163]++,sandbox.stub(util,&#x27;generateToken&#x27;).returns(generateTokenReturnValue));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[164]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[165]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;).returns(secret));cov_1ighra4x6r().s[166]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[167]++;sandbox.assert.calledOnce(secretSyncStub);cov_1ighra4x6r().s[168]++;sandbox.assert.calledOnce(generateTokenStub);cov_1ighra4x6r().s[169]++;sandbox.assert.calledWith(generateTokenStub,sinon_1.match({[secretName]:secret}));cov_1ighra4x6r().s[170]++;sandbox.assert.calledOnce(response.cookie);cov_1ighra4x6r().s[171]++;sandbox.assert.calledWith(response.cookie,config_1.default.jwt.name,generateTokenReturnValue);cov_1ighra4x6r().s[172]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;3cdc5655-055a-4d7c-8c44-1946a7e87666&quot;,&quot;parentUUID&quot;:&quot;83390ddc-61d3-44ad-99a8-c269048c1088&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;calls next if jwt with secret exists&quot;,&quot;fullTitle&quot;:&quot;jwt-csrf with ignored method \&quot;OPTIONS\&quot; calls next if jwt with secret exists&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_1ighra4x6r().f[31]++;/**\n                 * Stub generateToken method.\n                 */const generateTokenStub=(cov_1ighra4x6r().s[174]++,sandbox.stub(util,&#x27;generateToken&#x27;));/**\n                 * Stub set secret method for tokens.\n                 */const secret=(cov_1ighra4x6r().s[175]++,&#x27;SECRET&#x27;);const secretSyncStub=(cov_1ighra4x6r().s[176]++,sandbox.stub(csrf_1.default.prototype,&#x27;secretSync&#x27;));const jwt=(cov_1ighra4x6r().s[177]++,{[secretName]:secret});cov_1ighra4x6r().s[178]++;config_1.default.jwt.getToken=sandbox.stub().withArgs(request).returns(jwt);cov_1ighra4x6r().s[179]++;jwtCsrfHandler(request,response,next);cov_1ighra4x6r().s[180]++;sandbox.assert.notCalled(secretSyncStub);cov_1ighra4x6r().s[181]++;sandbox.assert.notCalled(generateTokenStub);cov_1ighra4x6r().s[182]++;sandbox.assert.notCalled(response.cookie);cov_1ighra4x6r().s[183]++;sandbox.assert.calledOnce(config_1.default.jwt.getToken);cov_1ighra4x6r().s[184]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;6883be44-97e7-4472-b054-a2b43f84fb55&quot;,&quot;parentUUID&quot;:&quot;83390ddc-61d3-44ad-99a8-c269048c1088&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;e0d7c26a-02dc-48aa-a045-d7ba04dfbdec&quot;,&quot;3cdc5655-055a-4d7c-8c44-1946a7e87666&quot;,&quot;6883be44-97e7-4472-b054-a2b43f84fb55&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;7370f67b-5be4-4789-a856-0a07a04e4a14&quot;,&quot;title&quot;:&quot;jwt-util&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-util \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[3]++;cov_15wj3jfxe0().s[23]++;/*\n         * Stub sign function with a fake which returns the given arguments inside\n         * an object.\n         */signStub=sandbox.stub(jsonwebtoken_1.default,&#x27;sign&#x27;).callsFake((payload,secret,options)=&gt;{cov_15wj3jfxe0().f[4]++;cov_15wj3jfxe0().s[24]++;return{payload,secret,options};});/**\n         * Stub `getOptions` of the config with a fake which\n         * returns the given argument.\n         * Real implementation is not relevant here.\n         */cov_15wj3jfxe0().s[25]++;getOptionsStub=sandbox.stub(config_1.default.jwt,&#x27;getOptions&#x27;).callsFake(subject=&gt;{cov_15wj3jfxe0().f[5]++;cov_15wj3jfxe0().s[26]++;if(subject!==undefined){cov_15wj3jfxe0().b[8][0]++;cov_15wj3jfxe0().s[27]++;return subject;}else{cov_15wj3jfxe0().b[8][1]++;cov_15wj3jfxe0().s[28]++;return config_1.default.jwt.notLoggedInSubject;}});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;44d76cea-39dd-4597-9683-c24eba596330&quot;,&quot;parentUUID&quot;:&quot;7370f67b-5be4-4789-a856-0a07a04e4a14&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-util \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[6]++;cov_15wj3jfxe0().s[30]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;775ca79c-035b-4986-95a3-515c7c769f63&quot;,&quot;parentUUID&quot;:&quot;7370f67b-5be4-4789-a856-0a07a04e4a14&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;a39782d6-31cf-43cc-8aa6-a1336472a670&quot;,&quot;title&quot;:&quot;generateToken&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;73576d25-afd4-4977-a55c-c2c8bd8d0144&quot;,&quot;title&quot;:&quot;generates token for user&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[{&quot;title&quot;:&quot;\&quot;before each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;jwt-util generateToken generates token for user \&quot;before each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[9]++;cov_15wj3jfxe0().s[36]++;user=user_1.default.build(userData);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5d1e5836-cd52-4936-91fc-6357f8ca17d4&quot;,&quot;parentUUID&quot;:&quot;73576d25-afd4-4977-a55c-c2c8bd8d0144&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;with subject&quot;,&quot;fullTitle&quot;:&quot;jwt-util generateToken generates token for user with subject&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:4,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[10]++;const subject=(cov_15wj3jfxe0().s[38]++,&#x27;subject&#x27;);const actual=(cov_15wj3jfxe0().s[39]++,jwt_util_1.generateToken(user,subject));cov_15wj3jfxe0().s[40]++;chai_1.expect(actual.payload).to.eql(expectedPayload);cov_15wj3jfxe0().s[41]++;chai_1.expect(actual.secret).to.equal(config_1.default.jwt.secret);cov_15wj3jfxe0().s[42]++;chai_1.expect(actual.options).to.equal(userData.username);cov_15wj3jfxe0().s[43]++;sandbox.assert.calledOnce(getOptionsStub);cov_15wj3jfxe0().s[44]++;sandbox.assert.calledWith(getOptionsStub,userData.username);cov_15wj3jfxe0().s[45]++;sandbox.assert.calledOnce(signStub);cov_15wj3jfxe0().s[46]++;sandbox.assert.calledWith(signStub,sinon_1.match(actual.payload),actual.secret,actual.options);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;0c8c1ac4-7cb1-46c8-90e7-462643ce86e1&quot;,&quot;parentUUID&quot;:&quot;73576d25-afd4-4977-a55c-c2c8bd8d0144&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;without subject&quot;,&quot;fullTitle&quot;:&quot;jwt-util generateToken generates token for user without subject&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[11]++;const actual=(cov_15wj3jfxe0().s[48]++,jwt_util_1.generateToken(user));cov_15wj3jfxe0().s[49]++;chai_1.expect(actual.payload).to.eql(expectedPayload);cov_15wj3jfxe0().s[50]++;chai_1.expect(actual.secret).to.equal(config_1.default.jwt.secret);cov_15wj3jfxe0().s[51]++;chai_1.expect(actual.options).to.equal(userData.username);cov_15wj3jfxe0().s[52]++;sandbox.assert.calledOnce(getOptionsStub);cov_15wj3jfxe0().s[53]++;sandbox.assert.calledWith(getOptionsStub,userData.username);cov_15wj3jfxe0().s[54]++;sandbox.assert.calledOnce(signStub);cov_15wj3jfxe0().s[55]++;sandbox.assert.calledWith(signStub,sinon_1.match(actual.payload),actual.secret,actual.options);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;b9804d7f-f8a8-44c2-9430-1cd5334aaade&quot;,&quot;parentUUID&quot;:&quot;73576d25-afd4-4977-a55c-c2c8bd8d0144&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;0c8c1ac4-7cb1-46c8-90e7-462643ce86e1&quot;,&quot;b9804d7f-f8a8-44c2-9430-1cd5334aaade&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:4,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;43d5a0bc-76f2-47e3-af27-9ae10c54e78d&quot;,&quot;title&quot;:&quot;generates token&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;with subject&quot;,&quot;fullTitle&quot;:&quot;jwt-util generateToken generates token with subject&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[13]++;const subject=(cov_15wj3jfxe0().s[60]++,&#x27;subject&#x27;);const actual=(cov_15wj3jfxe0().s[61]++,jwt_util_1.generateToken(payload,subject));cov_15wj3jfxe0().s[62]++;chai_1.expect(actual.payload).to.eql(expected);cov_15wj3jfxe0().s[63]++;chai_1.expect(actual.secret).to.equal(config_1.default.jwt.secret);cov_15wj3jfxe0().s[64]++;chai_1.expect(actual.options).to.equal(subject);cov_15wj3jfxe0().s[65]++;sandbox.assert.calledOnce(getOptionsStub);cov_15wj3jfxe0().s[66]++;sandbox.assert.calledWith(getOptionsStub,subject);cov_15wj3jfxe0().s[67]++;sandbox.assert.calledOnce(signStub);cov_15wj3jfxe0().s[68]++;sandbox.assert.calledWith(signStub,sinon_1.match(actual.payload),actual.secret,actual.options);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;814f8eec-6773-4e26-8f65-ff722d8b1686&quot;,&quot;parentUUID&quot;:&quot;43d5a0bc-76f2-47e3-af27-9ae10c54e78d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;without subject&quot;,&quot;fullTitle&quot;:&quot;jwt-util generateToken generates token without subject&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[14]++;const actual=(cov_15wj3jfxe0().s[70]++,jwt_util_1.generateToken(payload));cov_15wj3jfxe0().s[71]++;chai_1.expect(actual.payload).to.eql(expected);cov_15wj3jfxe0().s[72]++;chai_1.expect(actual.secret).to.equal(config_1.default.jwt.secret);cov_15wj3jfxe0().s[73]++;chai_1.expect(actual.options).to.equal(config_1.default.jwt.notLoggedInSubject);cov_15wj3jfxe0().s[74]++;sandbox.assert.calledOnce(getOptionsStub);cov_15wj3jfxe0().s[75]++;sandbox.assert.calledWith(getOptionsStub,sinon_1.match.typeOf(&#x27;undefined&#x27;));cov_15wj3jfxe0().s[76]++;sandbox.assert.calledOnce(signStub);cov_15wj3jfxe0().s[77]++;sandbox.assert.calledWith(signStub,sinon_1.match(actual.payload),actual.secret,actual.options);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9371ee55-94f4-45d0-8e1c-a7d9378265d4&quot;,&quot;parentUUID&quot;:&quot;43d5a0bc-76f2-47e3-af27-9ae10c54e78d&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;814f8eec-6773-4e26-8f65-ff722d8b1686&quot;,&quot;9371ee55-94f4-45d0-8e1c-a7d9378265d4&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;e410a811-93f7-4880-a263-bd72a0bb1f32&quot;,&quot;title&quot;:&quot;convertUserToJwtPayload&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;converts successfully&quot;,&quot;fullTitle&quot;:&quot;jwt-util convertUserToJwtPayload converts successfully&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[16]++;const userData=(cov_15wj3jfxe0().s[80]++,{username:&#x27;test&#x27;,email:&#x27;test@mail.com&#x27;,password:&#x27;password&#x27;,isBetaUser:true,other:&#x27;field&#x27;});const expected=(cov_15wj3jfxe0().s[81]++,{username:userData.username,isBetaUser:userData.isBetaUser,loggedIn:true});cov_15wj3jfxe0().s[82]++;chai_1.expect(jwt_util_1.convertUserToJwtPayload(userData)).to.be.eql(expected);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4cff6698-ef78-4d24-bf59-134202d7810e&quot;,&quot;parentUUID&quot;:&quot;e410a811-93f7-4880-a263-bd72a0bb1f32&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws error if no argument given&quot;,&quot;fullTitle&quot;:&quot;jwt-util convertUserToJwtPayload throws error if no argument given&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[17]++;cov_15wj3jfxe0().s[84]++;chai_1.expect(()=&gt;{cov_15wj3jfxe0().f[18]++;cov_15wj3jfxe0().s[85]++;return jwt_util_1.convertUserToJwtPayload(undefined);}).to.throw(TypeError);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ccc72f48-2eb8-4b4e-95a5-4b49a9a8c269&quot;,&quot;parentUUID&quot;:&quot;e410a811-93f7-4880-a263-bd72a0bb1f32&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;4cff6698-ef78-4d24-bf59-134202d7810e&quot;,&quot;ccc72f48-2eb8-4b4e-95a5-4b49a9a8c269&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;40c05edc-9073-45b7-ba19-c7ad131967e3&quot;,&quot;title&quot;:&quot;preLoginJwtValidator&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\jwt\\jwt-util.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;calls next if jwt not pre-login jwt&quot;,&quot;fullTitle&quot;:&quot;jwt-util preLoginJwtValidator calls next if jwt not pre-login jwt&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[20]++;const request=(cov_15wj3jfxe0().s[88]++,sandbox.stub());cov_15wj3jfxe0().s[89]++;request.user={loggedIn:true};const next=(cov_15wj3jfxe0().s[90]++,sandbox.stub());const response=(cov_15wj3jfxe0().s[91]++,sandbox.stub());cov_15wj3jfxe0().s[92]++;jwt_util_1.preLoginJwtValidator(request,response,next);cov_15wj3jfxe0().s[93]++;sandbox.assert.calledOnce(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;8c796160-d9b9-447b-bd3e-afd2c092f996&quot;,&quot;parentUUID&quot;:&quot;40c05edc-9073-45b7-ba19-c7ad131967e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if jwt doesn&#x27;t exist on request&quot;,&quot;fullTitle&quot;:&quot;jwt-util preLoginJwtValidator throws UnauthorizedError if jwt doesn&#x27;t exist on request&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[21]++;const request=(cov_15wj3jfxe0().s[95]++,sandbox.stub());const next=(cov_15wj3jfxe0().s[96]++,sandbox.stub());const response=(cov_15wj3jfxe0().s[97]++,sandbox.stub());cov_15wj3jfxe0().s[98]++;chai_1.expect(()=&gt;{cov_15wj3jfxe0().f[22]++;cov_15wj3jfxe0().s[99]++;return jwt_util_1.preLoginJwtValidator(request,response,next);}).to.throw(errors_1.UnauthorizedError);cov_15wj3jfxe0().s[100]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;a8cbca60-344a-4af9-ba0e-833d0f480587&quot;,&quot;parentUUID&quot;:&quot;40c05edc-9073-45b7-ba19-c7ad131967e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws UnauthorizedError if subject of jwt is pre-login subject&quot;,&quot;fullTitle&quot;:&quot;jwt-util preLoginJwtValidator throws UnauthorizedError if subject of jwt is pre-login subject&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_15wj3jfxe0().f[23]++;const request=(cov_15wj3jfxe0().s[102]++,sandbox.stub());cov_15wj3jfxe0().s[103]++;request.user={loggedIn:false};const next=(cov_15wj3jfxe0().s[104]++,sandbox.stub());const response=(cov_15wj3jfxe0().s[105]++,sandbox.stub());cov_15wj3jfxe0().s[106]++;chai_1.expect(()=&gt;{cov_15wj3jfxe0().f[24]++;cov_15wj3jfxe0().s[107]++;return jwt_util_1.preLoginJwtValidator(request,response,next);}).to.throw(errors_1.UnauthorizedError);cov_15wj3jfxe0().s[108]++;sandbox.assert.notCalled(next);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;73ef7e24-bd53-4527-b21a-86472d82bf1d&quot;,&quot;parentUUID&quot;:&quot;40c05edc-9073-45b7-ba19-c7ad131967e3&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;8c796160-d9b9-447b-bd3e-afd2c092f996&quot;,&quot;a8cbca60-344a-4af9-ba0e-833d0f480587&quot;,&quot;73ef7e24-bd53-4527-b21a-86472d82bf1d&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000},{&quot;uuid&quot;:&quot;05c758a8-a34f-4128-a563-c6d8b52e7529&quot;,&quot;title&quot;:&quot;User model&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\users\\user.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\users\\user.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[{&quot;title&quot;:&quot;\&quot;after each\&quot; hook&quot;,&quot;fullTitle&quot;:&quot;User model \&quot;after each\&quot; hook&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:null,&quot;speed&quot;:null,&quot;pass&quot;:false,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_2lw5onoxc1().f[3]++;cov_2lw5onoxc1().s[21]++;sandbox.restore();&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;12e3c71a-586d-4e00-8f67-c1dacf665e21&quot;,&quot;parentUUID&quot;:&quot;05c758a8-a34f-4128-a563-c6d8b52e7529&quot;,&quot;isHook&quot;:true,&quot;skipped&quot;:false}],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;2d410c68-aafb-420d-862a-0d6c4b8aff83&quot;,&quot;title&quot;:&quot;hashPasswordOfUser&quot;,&quot;fullFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\app\\users\\user.unit.spec.ts&quot;,&quot;file&quot;:&quot;\\app\\users\\user.unit.spec.ts&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;can hash string&quot;,&quot;fullTitle&quot;:&quot;User model hashPasswordOfUser can hash string&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_2lw5onoxc1().f[5]++;const password=(cov_2lw5onoxc1().s[24]++,&#x27;1234&#x27;);const fakeUser=(cov_2lw5onoxc1().s[25]++,{password});// Overwrite saltRounds in config\nconst saltRounds=(cov_2lw5onoxc1().s[26]++,2);cov_2lw5onoxc1().s[27]++;config.default.bcrypt.saltRounds=saltRounds;const fakeHash=(cov_2lw5onoxc1().s[28]++,&#x27;some hash&#x27;);const hashStub=(cov_2lw5onoxc1().s[29]++,sandbox.stub(bcrypt_1.default).hash.withArgs(sinon_1.match.string,saltRounds).resolves(fakeHash));cov_2lw5onoxc1().s[30]++;return user_1.hashPasswordOfUser(fakeUser).then(()=&gt;{cov_2lw5onoxc1().f[6]++;cov_2lw5onoxc1().s[31]++;chai_1.expect(fakeUser.password).to.equal(fakeHash);cov_2lw5onoxc1().s[32]++;sinon_1.assert.calledOnce(hashStub);cov_2lw5onoxc1().s[33]++;sinon_1.assert.calledWith(hashStub,password,saltRounds);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;5929bd42-4a6d-4269-b8af-57cad5a6cd82&quot;,&quot;parentUUID&quot;:&quot;2d410c68-aafb-420d-862a-0d6c4b8aff83&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;can hash number&quot;,&quot;fullTitle&quot;:&quot;User model hashPasswordOfUser can hash number&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:0,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_2lw5onoxc1().f[7]++;const password=(cov_2lw5onoxc1().s[35]++,1234);const fakeUser=(cov_2lw5onoxc1().s[36]++,{password});// Overwrite saltRounds in config\nconst saltRounds=(cov_2lw5onoxc1().s[37]++,2);cov_2lw5onoxc1().s[38]++;config.default.bcrypt.saltRounds=saltRounds;const fakeHash=(cov_2lw5onoxc1().s[39]++,&#x27;some hash&#x27;);const hashStub=(cov_2lw5onoxc1().s[40]++,sandbox.stub(bcrypt_1.default).hash.withArgs(sinon_1.match.string,sinon_1.match.number).resolves(fakeHash));cov_2lw5onoxc1().s[41]++;return user_1.hashPasswordOfUser(fakeUser).then(()=&gt;{cov_2lw5onoxc1().f[8]++;cov_2lw5onoxc1().s[42]++;chai_1.expect(fakeUser.password).to.equal(fakeHash);cov_2lw5onoxc1().s[43]++;sinon_1.assert.calledOnce(hashStub);cov_2lw5onoxc1().s[44]++;sinon_1.assert.calledWith(hashStub,password.toString(),saltRounds);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;85b13d48-562a-4288-be21-c6468619f3a8&quot;,&quot;parentUUID&quot;:&quot;2d410c68-aafb-420d-862a-0d6c4b8aff83&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;throws PasswordNotHashableError if bcrypt can&#x27;t hash&quot;,&quot;fullTitle&quot;:&quot;User model hashPasswordOfUser throws PasswordNotHashableError if bcrypt can&#x27;t hash&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:2,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;fast&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;context&quot;:null,&quot;code&quot;:&quot;cov_2lw5onoxc1().f[9]++;const fakeUser=(cov_2lw5onoxc1().s[46]++,{username:&#x27;demo&#x27;,password:1234});const expectedMessage=(cov_2lw5onoxc1().s[47]++,`Couldn&#x27;t hash the password for user \&quot;${fakeUser.username}\&quot;`);// Overwrite saltRounds in config\nconst saltRounds=(cov_2lw5onoxc1().s[48]++,2);cov_2lw5onoxc1().s[49]++;config.default.bcrypt.saltRounds=saltRounds;const hashStub=(cov_2lw5onoxc1().s[50]++,sandbox.stub(bcrypt_1.default,&#x27;hash&#x27;).withArgs(sinon_1.match.string,sinon_1.match.number).rejects());cov_2lw5onoxc1().s[51]++;return user_1.hashPasswordOfUser(fakeUser).catch(error=&gt;{cov_2lw5onoxc1().f[10]++;cov_2lw5onoxc1().s[52]++;chai_1.expect(fakeUser.password).to.equal(fakeUser.password);cov_2lw5onoxc1().s[53]++;sinon_1.assert.calledOnce(hashStub);cov_2lw5onoxc1().s[54]++;sinon_1.assert.calledWith(hashStub,fakeUser.password.toString(),saltRounds);cov_2lw5onoxc1().s[55]++;chai_1.expect(error).to.have.property(&#x27;message&#x27;,expectedMessage);cov_2lw5onoxc1().s[56]++;chai_1.expect(error).to.be.nested.property(&#x27;constructor.name&#x27;,&#x27;PasswordNotHashableError&#x27;);cov_2lw5onoxc1().s[57]++;chai_1.expect(error).to.have.property(&#x27;user&#x27;,fakeUser.username);});&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;59bd7d92-5977-4840-b49a-850fca2e194a&quot;,&quot;parentUUID&quot;:&quot;2d410c68-aafb-420d-862a-0d6c4b8aff83&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;5929bd42-4a6d-4269-b8af-57cad5a6cd82&quot;,&quot;85b13d48-562a-4288-be21-c6468619f3a8&quot;,&quot;59bd7d92-5977-4840-b49a-850fca2e194a&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:2,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:3000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:3000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;7.1.1&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:true,&quot;reportFilename&quot;:&quot;mochawesome&quot;,&quot;saveHtml&quot;:false,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;6.1.0&quot;},&quot;marge&quot;:{&quot;options&quot;:{&quot;quiet&quot;:&quot;true&quot;,&quot;html&quot;:&quot;false&quot;},&quot;version&quot;:&quot;5.1.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;index.html&quot;,&quot;reportDir&quot;:&quot;static\\test\\&quot;,&quot;reportTitle&quot;:&quot;group-car-api&quot;,&quot;reportPageTitle&quot;:&quot;Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:false,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;static\\test\\assets&quot;,&quot;htmlFile&quot;:&quot;C:\\Users\\Simon\\Projects\\group-car\\group-car-api\\static\\test\\index.html&quot;}"><div id="report"></div><script src="assets\app.js"></script></body></html>